<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html> 
  <head> 
    <title>Schools within Radius</title> 
    <!-- Load Google Closure CSS and JS files to provide a slider and a dialog
    box --> 
    <link rel="stylesheet" href="common.css"> 
    <link rel="stylesheet" href="dialog.css"> 
    <script type="text/javascript" src="closurec.js"></script> 
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
		<script src="distancewidget.js" type="text/javascript" charset="utf-8"></script>

    <style> 
    body {
      font-size: small;
      font-family: sans-serif;
    }
    .goog-slider-horizontal {
      border: solid 1px #CCCCCC;
      background-color: white;
      position: relative;
      overflow: hidden;
    }

    .goog-slider-thumb {
      position: absolute;
      background-color: #3399CC;
      overflow: hidden;
      width: 10px;
      height: 100%;
      top: 0;
    }

    #map {
      border: 1px solid black;
      margin-bottom: 10px;
    }
    </style> 

  <script> 
  goog.require('goog.ui.Dialog');
  goog.require('goog.ui.Slider');
  goog.require('goog.ui.Component');
  var map, sliderTimer, layer, slider, marker, circle;
	var radius = 10000; // 10 km

	mapCenter = new google.maps.LatLng(37.774929500000006, -122.30955221875001);
  function initializeMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      center: mapCenter,
      zoom: 9,
      mapTypeId: 'roadmap'
    });

		var tableid = 517214;

    layer = new google.maps.FusionTablesLayer(tableid, {
      suppressInfoWindows: true
    });
    layer.setMap(map);

		// Create a draggable marker which will later on be binded to a
	  // Circle overlay.
		marker = new google.maps.Marker({
	  	map: map,
	    position: mapCenter,
	    draggable: true,
	    title: 'Drag me!'
	  });
	
		// Add a Circle overlay to the map.

	 circle = new google.maps.Circle({
			map: map,
    	radius: radius
		});

    // Since Circle and Marker both extend MVCObject, you can bind them
    // together using MVCObject's bindTo() method.  Here, we're binding
    // the Circle's center to the Marker's position.
    // http://code.google.com/apis/maps/documentation/v3/reference.html#MVCObject
    // circle.bindTo('center', marker, 'position');
		updateCircleLocation();
		
	
    google.maps.event.addListener(layer, 'click', displayData);
    initializeSlider();
  }

	// Update current position info.
  // updateMarkerPosition(mapCenter);

	// Update circle location
	function updateCircleLocation() {
		circle.bindTo('center', marker, 'position');
	}
	

  // When a user clicks on a feature on the map, intercept the
  // click event and display the data in a modal dialog box.
  function displayData(mouseEvent) {
    var dialog = new goog.ui.Dialog();
    dialog.setTitle(mouseEvent.row['name'].value);
    dialog.setContent(formatTableRowAsHtml(mouseEvent.row));
    dialog.setButtonSet(goog.ui.Dialog.ButtonSet.OK);
    dialog.setVisible(true);
  }

  // Produce some nicely formatted HTML using the raw row data exposed as
  // part of the feature click event.
  function formatTableRowAsHtml(row) {
    var parts = [
      '<center><img width="400px" height="200px" src="',
      row['pic_link'].value,
      '"></img><br>',
      '<b>elevation: </b>',
      row['min_elevation'].value,
      ' to ',
      row['max_elevation'].value,
      ' feet</center>'
    ];
    return parts.join('');
  }

  // Create a Google Closure slider bar which can be used to select the
  // distance by which to filter the Fusion Tables data.
  function initializeSlider() {
      var sliderElement = document.getElementById('slider');
      slider = new goog.ui.Slider;
      slider.decorate(sliderElement);
      slider.addEventListener(goog.ui.Component.EventType.CHANGE, function() {
        // Avoid updating the map too often by ignoring slider value changes
        // that occur within 200mS of eachother.
        if (sliderTimer) window.clearTimeout(sliderTimer);
        sliderTimer = window.setTimeout(updateMap, 200);
        document.getElementById("slider-value").innerHTML = slider.getValue() + " mi";
      });
      slider.setValue(25);
  }

  // Convert a slider value (0 - 100%) to an distance between 0 and 3000.
  function sliderValueToKm(value) {
    return Math.round(value * 1.609344);
  }

  // Update the query used to filter Fusion Tables data using the
  // current value of the slider.
  function updateMap() {
    radius = sliderValueToKm(slider.getValue());
		// updateQuery = "SELECT City FROM " + tableid + " WHERE ST_INTERSECTS(City, CIRCLE(LATLNG(" + marker.getPosition().lat() + "," + marker.getPosition().lng() + ")," + radius + "))";
		// layer.setQuery(updateQuery);
  }



  </script> 
  <body onLoad="initializeMap()"> 
    <div id="options" style="display: block;"> 
      <p>Show schools within:</p> 
      <div id="slider" class="goog-slider" style="width: 480px; height: 15px; float: left"> 
        <div class="goog-slider-thumb"></div> 
      </div> 
      <div id="slider-value" style="float: left; margin-left: 5px;"></div> 
    </div> 
    <br clear="all"/> 
    <div id="map" style="width: 512px; height: 420px; margin-top: 10px"></div> 
  </body> 
</html>
